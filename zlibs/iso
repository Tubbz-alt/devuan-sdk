#!/usr/bin/env zsh

# Devuan SDK - iso image management

# Copyright (C) 2015 Dyne.org Foundation
#
# Devuan SDK is designed, written and maintained by Denis Roio <jaromil@dyne.org>
#
# This source code is free software; you can redistribute it and/or
# modify it under the terms of the GNU Public License as published by
# the Free Software Foundation; either version 3 of the License, or
# (at your option) any later version.
#
# This source code is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  Please refer
# to the GNU Public License for more details.
#
# You should have received a copy of the GNU Public License along with
# this source code; if not, write to: Free Software Foundation, Inc.,
# 675 Mass Ave, Cambridge, MA 02139, USA.

seed iso() {
    fn iso
    freq=(seeds)
    ckreq

    seeds=`ls $sdk_path/seeds`
    sel=$1

    # check if selected iso is in preseeds
    [[ -r $sdk_path/seeds/${sel} ]] || {
        error "iso type not supported: $1"
        return 1
    }

    iso_type=$sel
    act "Selected iso type: $iso_type"
}

auto-iso() {
    fn iso
    req=(iso_type)
    ckreq

    iso-import

    iso-replace-packages

    iso-seed

    iso-index

    iso-make
}

iso-del-package() {
    fn iso-del-package
    req=(release chroot_arch iso_type)
    iso=usr/src/devuan-iso/$release-$chroot_arch-$iso_type
    pname=$1
    freq=(chroot/$chroot_arch/$iso/README.html)
    reqck || return $?

    notice "Deleting package from $release $chroot_arch $iso_type: $pname"
    chdo \
        rm -rf /$iso/pool/main/${pname[1]}/$pname/
}

iso-add-package() {
    fn iso-add-package
    req=(release chroot_arch iso_type)
    iso=usr/src/devuan-iso/$release-$chroot_arch-$iso_type
    pname=$1
    freq=(builds/$pname chroot/$chroot_arch/$iso/README.html)
    reqck || return $?

    notice "Adding package to $release $chroot_arch $iso_type: $pname"

    # add all packages compiled from this source
    debs=(`find $sdk_path/builds/$pname/ -name "*${chroot_arch}*deb"`)
    debs+=(`find $sdk_path/builds/$pname/ -name "*all*deb"`)
    for p in $debs
    do
        pb=`basename $p`
        [[ -r $p ]] && {
            sudo mkdir -p $sdk_path/chroot/$chroot_arch/$iso/pool/main/${pname[1]}/$pname/
            sudo cp $p $sdk_path/chroot/$chroot_arch/$iso/pool/main/${pname[1]}/$pname/
            act "add $pb"
        }
    done

}

# add a preseed.cfg file
iso-add-preseed() {
    fn iso-add-preseed
    req=(chroot_arch)
    iso=usr/src/devuan-iso/$release-$chroot_arch-$iso_type
    freq=(chroot/$chroot_arch/$iso/README.html)
    reqck || return $?


    root=$sdk_path/chroot/$chroot_arch
    iso=usr/src/devuan-iso/$release-$chroot_arch-$iso_type

    q_name=$1

    [[ -r $q_name ]] || {
        error "preseed file not found $q_name"
        return 1
    }


    notice "Adding preseed to $release $chroot_arch iso: $iso_type"

    # saves it in the root of the iso for consultation
    sudo cp $q_name $root/$iso/preseed.cfg

    # prepare the script to substitute initrds
    tmp=`mktemp`
    cat <<EOF >> $tmp
#!/bin/zsh

initrds=\`find /$iso -name initrd.gz\`
for i in \${(f)initrds}; do
    print "Replacing \$i"
    rm -rf /usr/src/devuan-iso/initrd-tmp
    mkdir -p /usr/src/devuan-iso/initrd-tmp
    pushd /usr/src/devuan-iso/initrd-tmp
    gzip -d < \$i | cpio --extract  --make-directories --no-absolute-filenames
    cp /$iso/preseed.cfg .
    rm -f \$i
    find . | cpio -H newc --create  | gzip -9 > \$i
    print "Replaced \$i"
    popd
    rm -rf /usr/src/devuan-iso/initrd-tmp
done
EOF
    chmod +x $tmp
    sudo mv $tmp $root/usr/src/devuan-iso/$release-$chroot_arch-preseed-script
    chdo /usr/src/devuan-iso/$release-$chroot_arch-preseed-script

    notice "Done adding preseed $iso_type"
}

# add a preseed.cfg file
iso-rm-preseed() {
    fn iso-rm-preseed
    req=(chroot_arch)
    iso=usr/src/devuan-iso/$release-$chroot_arch-$iso_type
    freq=(chroot/$chroot_arch/$iso/README.html)
    reqck || return $?


    root=$sdk_path/chroot/$chroot_arch
    iso=usr/src/devuan-iso/$release-$chroot_arch-$iso_type

    notice "Removing preseed from $release $chroot_arch iso"

    # prepare the script to substitute initrds
    tmp=`mktemp`
    cat <<EOF >> $tmp
#!/bin/zsh

initrds=\`find /$iso -name initrd.gz\`
for i in \${(f)initrds}; do
    print "Removing preseed from \$i"
    rm -rf /usr/src/devuan-iso/initrd-tmp
    mkdir -p /usr/src/devuan-iso/initrd-tmp
    pushd /usr/src/devuan-iso/initrd-tmp
    gzip -d < \$i | cpio --extract  --make-directories --no-absolute-filenames
    rm -f preseed.cfg
    rm -f \$i
    find . | cpio -H newc --create  | gzip -9 > \$i
    print "Replaced \$i"
    popd
    rm -rf /usr/src/devuan-iso/initrd-tmp
done
EOF
    chmod +x $tmp
    sudo mv $tmp $root/usr/src/devuan-iso/$release-$chroot_arch-preseed-script
    chdo /usr/src/devuan-iso/$release-$chroot_arch-preseed-script

    rm -f $iso/preseed.cfg

    notice "Done removing preseed"
}


iso-import() {
    fn iso-import
    req=(release installer chroot_arch iso_type)
    reqck || return $?

    case $iso_type in
        netinst*)
            iso_img=debian-$release-DI-rc1-$chroot_arch-netinst.iso
            ;;
        xfce*)
            iso_img=debian-$release-DI-rc1-$chroot_arch-xfce-CD-1.iso
            ;;
        *)
            error "ISO type not supported: $iso_type"
            ;;
    esac


    # TODO change with final release of Debian when ready
    debian_iso_url=$installer/$iso_img

    root=$sdk_path/chroot/$chroot_arch

    src=$root/usr/src

    sudo \
        mkdir -p $src/debian-iso/$release-$chroot_arch-$iso_type

    if [[ -r $src/debian-iso/$iso_img ]]; then
        notice "Iso image found in chroot"
        ls -lh $src/debian-iso/$iso_img
    else
        notice "Downloading Debian $iso_type iso"
        act "from: $installer"

        sudo \
            curl $debian_iso_url \
            -o $src/debian-iso/$iso_img
    fi

    notice "Importing Debian $iso_type iso"
    act "release: $release"
    act "architecture: $chroot_arch"

    sudo mkdir -p $src/devuan-iso/$release-$chroot_arch-$iso_type

    sudo mount -o loop $root/usr/src/debian-iso/$iso_img \
        $root/usr/src/debian-iso/$release-$chroot_arch-$iso_type

    sudo rsync --delete -rX $root/usr/src/debian-iso/$release-$chroot_arch-$iso_type/* \
        $root/usr/src/devuan-iso/$release-$chroot_arch-$iso_type/

    sudo umount $root/usr/src/debian-iso/$release-$chroot_arch-$iso_type

}

# takes an argument: directory storing packages to inject
# default to $sdk_path/builds
iso-replace-packages() {
    fn iso-replace-packages
    req=(release chroot_arch)
    root=$sdk_path/chroot/$chroot_arch
    iso=usr/src/devuan-iso/$release-$chroot_arch-$iso_type
    freq=(chroot/$chroot_arch/$iso/README.html)
    reqck || return $?

    sdir=${1:-$sdk_path/builds}

    notice "Replacing iso packages with those found in $sdir"
    act "release $release arch $chroot_arch"

    typeset -A dvn_builds
    # gather a map of builds we have locally
    sdir_f=`find $sdir -type f -name "*deb"`
    for s in ${(f)sdir_f}; do
        pname=`basename $s | file-to-name`
        # check version differences too
        # or make a pass and remove older versions
        # pver=`print $pfile | file-to-ver`
        dvn_builds+=($pname $s)
    done

    typeset -A deb_builds
    # gather a map of packages in the iso
    ddir_f=`find $root/$iso/pool -type f -name "*deb"`
    for d in ${(f)ddir_f}; do
        pname=`basename $d | file-to-name`
        deb_builds+=($pname $d)
    done

    # make sure the destination dir for our packages exists
#    sudo mkdir -p $root/$iso/pool/main/devuan

    c=0
    for deb in ${(k)deb_builds}; do
        # check if deb package is found in our builds
        [[ "$dvn_builds[$deb]" = "" ]] || {

            ours=$dvn_builds[$deb]
            ours_b=`basename $ours`
            ours_d=`dirname $ours`
            theirs=$deb_builds[$deb]
            theirs_b=`basename $theirs`
            theirs_d=`dirname $theirs`

            func "ours   $ours_b"
            func "theirs $theirs_b"
            # skip if exactly same package (already substituted)
            [[ "$ours_b" = "$theirs_b" ]] && continue

            sudo cp $ours $theirs_d
            act "add $ours_b"

            sudo rm $theirs
            act "sub $theirs_b"
            c=$(( $c + 1 ))
        }
    done
    notice "$c packages substituted"
}

iso-index iso-prepare() {
    fn iso-index
    req=(release chroot_arch)
    root=$sdk_path/chroot/$chroot_arch
    iso=usr/src/devuan-iso/$release-$chroot_arch-$iso_type
    freq=(chroot/$chroot_arch/$iso/README.html)
    reqck || return $?

    notice "Indexing all packages inside the iso"

    # ?? bzip2

    tmp=`mktemp`
    cat <<EOF >> $tmp
Dir {
   ArchiveDir "$release-$chroot_arch-$iso_type";
   OverrideDir "indices";
   CacheDir "indices";
};

TreeDefault {
   Directory "pool/";
};

BinDirectory "pool/main" {
   Packages "dists/$release/main/debian-installer/binary-$chroot_arch/Packages";
   BinOverride "override";
#   ExtraOverride "override.extra";
};

Default {
   Packages {
       Extensions ".udeb";
   };
};
EOF
    sudo mv $tmp $root/usr/src/devuan-iso/config-udeb

    tmp=`mktemp`
    cat <<EOF >> $tmp
Dir {
   ArchiveDir "$release-$chroot_arch-$iso_type";
   OverrideDir "indices";
   CacheDir "indices";
};

TreeDefault {
   Directory "pool/";
};
BinDirectory "pool/main" {
   Packages "dists/$release/main/binary-$chroot_arch/Packages";
   BinOverride "override";
#   ExtraOverride "override.extra";
};

Default {
   Packages {
       Extensions ".deb";
   };
EOF

    sudo mv $tmp $root/usr/src/devuan-iso/config-deb

    sudo mkdir -p $root/usr/src/devuan-iso/indices
    tmp=`mktemp`

    # TODO
    # here we grep out systemd from the indices/override this may be a
    # bit too aggressive and it might be better to do it by hand
    chdo \
        rm -f /usr/src/devuan-iso/indices/override
    tmpoverride=`mktemp`
    gunzip $sdk_path/seeds/override.$release.main.gz -c >> $tmpoverride
    sudo \
        mv $tmpoverride $root/usr/src/devuan-iso/indices/override

    schroot -c devuan-$chroot_arch \
        -u root -d $root/usr/src/devuan-iso -- \
        apt-ftparchive generate config-udeb

    schroot -c devuan-$chroot_arch \
        -u root -d $root/usr/src/devuan-iso -- \
        apt-ftparchive generate config-deb

    tmp=`mktemp`
    cat <<EOF >> $tmp
APT::FTPArchive::Release::Codename "$release";
APT::FTPArchive::Release::Origin "Devuan";
APT::FTPArchive::Release::Components "main";
APT::FTPArchive::Release::Label "$iso_type";
APT::FTPArchive::Release::Architectures "$chroot_arch";
APT::FTPArchive::Release::Suite "testing";
EOF
    sudo mv $tmp $root/usr/src/devuan-iso/config-rel

    tmp=`mktemp`
    schroot -c devuan-$chroot_arch \
        -u root -d $root/usr/src/devuan-iso -- \
        apt-ftparchive -c config-rel release \
        $release-$chroot_arch-$iso_type/dists/$release \
        >> $tmp

    sudo mv $tmp $root/$iso/dists/$release/Release

    # taken from https://wiki.debian.org/DebianInstaller/Modify/CD#Fix_md5sum.27s
    pushd $root/usr/src/devuan-iso/$release-$chroot_arch-$iso_type
    tmpmd5=`mktemp`
    sudo md5sum `find ! -name "md5sum.txt" ! -path "./isolinux/*" -follow -type f` >> $tmpmd5
    sudo mv $tmpmd5 md5sum.txt
    popd
}

# auxiliary function used internally
# prints out section contents of seed file
_seed-section() {
    # $1 seed file
    # $2 section in seed
    act "$1"
    awk 'BEGIN { found=0 }
/^#\+ '"$1"'/ { found=1; next }
/^#\+/ { if(found==1) exit 0 }
/^$/ { next }
{ if(found==1) print $0 }
' $sdk_path/seeds/$iso_type
}
iso-seed() {
    fn iso-seed
    req=(release chroot_arch)
    root=$sdk_path/chroot/$chroot_arch
    iso=usr/src/devuan-iso/$release-$chroot_arch-$iso_type
    freq=(chroot/$chroot_arch/$iso/README.html)
    reqck || return $?

    sudo chmod u+w $root/$iso

    notice "Planting iso with seed: $iso_type"

    # here parsing of the selected seeds file is done
    # every section is marked with a fixed string preceeded by #+
    # sections are:
    #+ base exclude
    #+ base include
    #+ debian preseed
    #+ package add
    #+ package remove

    mkdir -p $root/$iso/.disk

    tmpexclude=`mktemp`
    _seed-section "base exclude" >> $tmpexclude
    [[ $debug = 1 ]] && {
        tmp=`cat $tmpexclude`
        for i in ${(f)tmp}; do func "$i"; done
    }
    sudo mv $tmpexclude $root/$iso/.disk/base_exclude

    tmpinclude=`mktemp`
   _seed-section "base include" >> $tmpinclude
    [[ $debug = 1 ]] && {
        tmp=`cat $tmpinclude`
        for i in ${(f)tmp}; do func "$i"; done
    }
    sudo mv $tmpinclude $root/$iso/.disk/base_include


    # delete packages
    tmpdel=`mktemp`
    _seed-section "package del" >> $tmpdel
    pdel=`cat $tmpdel`
    rm -f $tmpdel
    for p in ${(f)pdel}; do
        iso-del-package $p
    done

    # add packages
    tmppadd=`mktemp`
    _seed-section "package add" >> $tmppadd
    padd=`cat $tmppadd`
    rm -f $tmppadd
    for p in ${(f)padd}; do
        iso-add-package $p
    done

    # inject own debian-installer if in builds
    [[ -r $sdk_path/builds/debian-installer/dest-$chroot_arch ]] && {
        act "adding own build of debian-installer for $chroot_arch"
        case $chroot_arch in
            i386)
                sudo cp -vf \
                    $sdk_path/builds/debian-installer/dest-$chroot_arch/cdrom/vmlinuz \
                    $root/$iso/install.386/vmlinuz
                sudo cp -vf \
                    $sdk_path/builds/debian-installer/dest-$chroot_arch/cdrom/initrd.gz \
                    $root/$iso/install.386/initrd.gz
                sudo cp -vf \
                    $sdk_path/builds/debian-installer/dest-$chroot_arch/cdrom/gtk/vmlinuz \
                    $root/$iso/install.386/gtk/vmlinuz
                sudo cp -vf \
                    $sdk_path/builds/debian-installer/dest-$chroot_arch/cdrom/gtk/initrd.gz \
                    $root/$iso/install.386/gtk/initrd.gz
                ;;
            *) ;;
        esac
    }

    # inject preseed from selected seed (iso_type)
    tmpreseed=`mktemp`
    _seed-section "debian preseed" >> $tmpreseed
    [[ $debug = 1 ]] && {
        tmp=`cat $tmpreseed`
        for i in ${(f)tmp}; do func "$i"; done
    }
    iso-add-preseed $tmpreseed
    rm -f $tmpreseed

    # write the distro name, release, architecture, image type and date
    tmpinfo=`mktemp`
    cat << EOF >> $tmpinfo
Devuan GNU/Linux "$release" - $chroot_arch $iso_type `date +%Y%m%d-%H:%M`
EOF
    sudo mv $tmpinfo $root/$iso/.disk/info
}

iso-make() {
    fn iso-make
    req=(chroot_arch release)
    root=$sdk_path/chroot/$chroot_arch
    iso=usr/src/devuan-iso/$release-$chroot_arch-$iso_type
    freq=(chroot/$chroot_arch/$iso/README.html)
    reqck || return $?

    notice "Toasting $iso_type for $release $chroot_arch"

    schroot -c devuan-$chroot_arch \
        -u root -d $root/usr/src/devuan-iso -- \
        xorriso -as mkisofs -output devuan-$release-$chroot_arch-$so_type.iso \
        -iso-level 3 -full-iso9660-filenames -r -J -no-emul-boot -boot-load-size 4 \
        -isohybrid-mbr /usr/lib/ISOLINUX/isohdpfx.bin -partition_offset 16 \
        -boot-info-table -b isolinux/isolinux.bin -c isolinux/boot.cat \
        ./$release-$chroot_arch-$iso_type

    mkdir -p $sdk_path/iso
    cp $root/usr/src/devuan-iso/devuan-$release-$chroot_arch-$iso_type.iso \
        $sdk_path/iso/

    pushd $sdk_path
    notice "$iso_type ISO ready for $release $chroot_arch"
    act " `ls -lh iso/devuan-$release-$chroot_arch-$iso_type.iso`"
    popd
}
